apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: postgres-master-pvc
spec:
  accessModes: [ReadWriteOnce]
  resources:
    requests:
      storage: 1Gi
---
apiVersion: v1
kind: Service
metadata:
  name: postgres-master
spec:
  ports:
  - port: 5432
  selector:
    app: postgres-master
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-master
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres-master
  template:
    metadata:
      labels:
        app: postgres-master
    spec:
      containers:
      - name: postgres
        image: postgres:13
          env:
        - name: POSTGRES_USER
          value: "admin"
        - name: POSTGRES_PASSWORD
          value: "password"
        - name: POSTGRES_DB
          value: "calculator_db"
        - name: PGDATA
          value: "/var/lib/postgresql/data/pgdata"

        # Ø§ÛŒÙ† Ù‚Ø³Ù…Øª ØªØ¶Ù…ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ú©Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ Ù‡Ù…ÛŒØ´Ù‡ Ø¨Ø§Ø² Ø¨Ø§Ø´Ù†Ø¯
        command: ["/bin/bash", "-c"]
        args:
        - |
          # Ø³Ø§Ø®Øª Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ Ø¯ÛŒØªØ§ Ø§Ú¯Ø± Ù†Ø¨Ø§Ø´Ø¯
          mkdir -p /var/lib/postgresql/data/pgdata
          chown -R postgres:postgres /var/lib/postgresql/data

          # Ø§Ø¬Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¯Ø± Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ú©Ø§Ù†ÙÛŒÚ¯â€ŒÙ‡Ø§
          docker-entrypoint.sh postgres &
          PID=$!

          # ØµØ¨Ø± Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ ÙØ§ÛŒÙ„ Ú©Ø§Ù†ÙÛŒÚ¯ Ø³Ø§Ø®ØªÙ‡ Ø´ÙˆØ¯
          sleep 10

          echo "ðŸ”§ Configuring pg_hba.conf for access..."
          # Ø§ÛŒÙ† Ø®Ø·ÙˆØ· Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ùˆ Ú©Ù„Ø§ÛŒÙ†Øªâ€ŒÙ‡Ø§ (Ù…Ø«Ù„ Ù¾Ø§Ø±Ø³Ø±) Ø±Ø§ Ø¨Ø§Ø² Ù…ÛŒâ€ŒÚ©Ù†Ù†Ø¯
          echo "host replication all 0.0.0.0/0 trust" >> /var/lib/postgresql/data/pgdata/pg_hba.conf
          echo "host all all 0.0.0.0/0 trust" >> /var/lib/postgresql/data/pgdata/pg_hba.conf

          # Ù…Ù†ØªØ¸Ø± Ù…ÛŒâ€ŒÙ…Ø§Ù†ÛŒÙ… ØªØ§ Ù¾Ø±ÙˆØ³Ù‡ Ø§ÙˆÙ„ÛŒÙ‡ ØªÙ…Ø§Ù… Ø´ÙˆØ¯
          wait $PID

        volumeMounts:
        - name: master-data
          mountPath: /var/lib/postgresql/data
      volumes:
      - name: master-data
        persistentVolumeClaim:
          claimName: postgres-master-pvc
